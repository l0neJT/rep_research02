---
title: "Damage Analysis of U.S. Storm Activity"
author: "Logan J Travis"
date: "21 June 2014"
output: html_document
---

## Synopziz

## Data Processing

Data provided by NOAA for storm actity from 1950 through November 2011. Please see the 

### Access Data

```{r accessDat}
# Store link to NOAA Storm Data
link <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"

# Download data and save to ./data if not present
# Checks for timestamp downloading a new copy of the data if not present
if(!file.exists("./data")) dir.create("./data")
if(sum(file.exists(c("./data/StormData.csv.bz2", "./data/Timestamp.txt"))) < 2 ) {
    download.file(link, destfile = "./data/StormData.csv.bz2", method = "curl")
    write.table(date(), file = "./data/Timestamp.txt", col.names = F, row.names = F)
    print("Storm Data downloaded succesfully")
} else {
    timestamp <- format(read.table("./data/Timestamp.txt"))
    print(paste("Using Storm Data with timestamp", timestamp))
}
```

### Read Data
```{r readDat}
# Load data.table package
library(data.table)

# List column classes including NULL to skip data not used in analysis
cols <- c("numeric",  # STATE
          "character",  # BGN_DATE (will convert to Date)
          "NULL",  # BGN_TIME
          "NULL",  # BGN_TIME
          "NULL",  # COUNTY
          "NULL",  # COUNTYNAME
          "factor",  # STATE
          "character",  # EVTYPE (character class to simplify cleanup)
          "NULL",  # BGN_RANGE
          "NULL",  # BGN_AZI
          "NULL",  # BGN_LOCATION
          "NULL",  # END_DATE (too many blanks for useful analysis)
          "NULL",  # END_TIME
          "NULL",  # COUNTY_END
          "NULL",  # COUNTYENDN
          "NULL",  # END_RANGE
          "NULL",  # END_AZI
          "NULL",  # END_LOCATION
          "NULL",  # LENGTH
          "NULL",  # WIDTH
          "NULL",  # F
          "NULL",  # MAG
          "numeric",  # FATALITIES
          "numeric",  # INJURIES
          "numeric",  # PROPDMG
          "factor",  # PROPDMGEXP
          "numeric",  # CROPDMG
          "factor",  # CROPDMGEXP
          "NULL",  # WFO
          "NULL",  # STATEOFFICE
          "NULL",  # ZONENAMES
          "NULL",  # LATTITUDE
          "NULL",  # LONGITUDE
          "NULL",  # LATITUDE_E
          "NULL",  # LONGITUDE_
          "NULL",  # REMARKS
          "numeric"  # REFNUM
         )

# Read Storm Data then convert to data.table to speed cleanup
# Calls read.csv() because fread produced an unknown error
dat <- data.table(read.csv("./data/StormData.csv.bz2", colClasses = cols))

# Print data summary
print(str(dat))

# Clear variables
rm(cols)
```

### Clean Data
1. Change STATE__ columne name to STATENUM
```{r cleanDatSTATENUM}
    setnames(dat, "STATE__", "STATENUM")
```
2. Convert begin date from character to Date format then add separate year column
    ```{r cleanDatDate}
    dat$BGN_DATE <- dat[, as.Date(BGN_DATE, format = "%m/%d/%Y %T")]
    dat[, YEAR := year(BGN_DATE)]
    ```
3. Clean event types (multiple steps)
    ```{r cleanDatEVTYPE, cache = TRUE}
    # Create data.frame of unique EVTYPE values
    # Copies columns to enable replacement matching
    evtypes <- summarize(dat, EVTYPE = count(EVTYPE))[[1]]
    evtypes$clean <- evtypes$x
    
    # Convert to upper case
    evtypes$clean <- toupper(evtypes$clean)
    
    # Remove leading space
    evtypes$clean <- gsub("^ +", "", evtypes$clean)
    
    # Replace 'THUNDERSTORM' with 'TSTM'
    evtypes$clean <- gsub("THUNDERSTORM", "TSTM", evtypes$clean)
    
    # Truncate 'TSTM WIND'
    evtypes$clean[grepl("^TSTM WIND", evtypes$clean)] <- "TSTM WIND"
    
    # Truncate 'HAIL'
    evtypes$clean[grepl("^HAIL", evtypes$clean)] <- "HAIL"
    
    # Truncate 'HEAVY SNOW'
    evtypes$clean[grepl("^HEAVY SNOW", evtypes$clean)] <- "HEAVY SNOW"
    
    # Truncate 'LIGHTNING'
    evtypes$clean[grepl("^LIGHTNING", evtypes$clean)] <- "LIGHTNING"
    
    # Simplify 'FLASH FLOOD' and 'FLOOD'
    evtypes$clean <- gsub("FLASH FLOOD.*FLOOD", "FLASH FLOOD", evtypes$clean)
    
    # Simplify then truncate 'HEAVY RAIN' (includes 'HEAVY PRECIPITATION' and 'HEAVY SHOWERS')
    evtypes$clean <- gsub("HEAVY (PRECIPITATION|SHOWERS)", "HEAVY RAIN", evtypes$clean)
    evtypes$clean[grepl("^HEAVY RAIN", evtypes$clean)] <- "HEAVY RAIN"
    
    # Simplify then truncate 'HIGH WIND(S)' and 'STRONG WIND(S)'
    evtypes$clean <- gsub("(HIGH|STRONG) WIND", "HIGH WIND", evtypes$clean)
    evtypes$clean[grepl("^HIGH WIND", evtypes$clean)] <- "HIGH WIND"
    
    # Simplify 'TORNADO'
    evtypes$clean[grepl("TORNADO", evtypes$clean)] <- "TORNADO"
    
    # Replace non-alphanumeric with . and remove duplicates
    evtypes$clean <- gsub("[^0-9A-Z]", ".", evtypes$clean)
    evtypes$clean <- gsub("\\.{2, }", ".", evtypes$clean)

    # Merge clean event types into data
    evtypesMerge <- data.table(EVTYPE = evtypes$x, EVTYPECLEAN = evtypes$clean)
    dat <- merge(dat, evtypesMerge, by = "EVTYPE", all.x = TRUE)
    ```
4. Multiply property and crop damage by 'EXP' to calculate total
    ```{r cleanDatDamage}
    # Create function to lookup 'EXP' multiple
    expMultiple <- function(exp) {
        switch(tolower(exp), k = 1E+3, m = 1E+6, b = 1E+9, 1)
    }
    
    # Add total property and crop damage columns
    dat[, PROPDMGTOT := {exp <- sapply(dat$PROPDMGEXP, expMultiple); PROPDMG * exp}]
    dat[, CROPDMGTOT := {exp <- sapply(dat$CROPDMGEXP, expMultiple); CROPDMG * exp}]

    # Add total damage column
    dat[, DMGTOT := PROPDMGTOT + CROPDMGTOT]
    ```
5. Clear temporary variables
    ```{r cleanDatClear}
    rm(evtypes, evtypesMerge, expMultiple)
    ```
## Results

### Summary Statistics
Summarize by year instead of individual events
```{r sumStats}
# Summarize data by year and type
datSumYearType <- dat[, list(sum(FATALITIES), sum(INJURIES), sum(DMGTOT)),
                      by = c("YEAR", "EVTYPECLEAN")]
setnames(datSumYearType, c("YEAR", "EVTYPE", "FATALITIES", "INJURIES", "DMGTOT"))
```

#### Annual Fatalities
```{r sumStatsFtl}
datStatsFtl <- datSumYearType[, as.list(summary(FATALITIES)), by = EVTYPE]
datStatsFtl <- datStatsFtl[order(Mean, decreasing = TRUE)]
```

#### Injuries
```{r sumStatsInj}
datStatsInj <- datSumYearType[, as.list(summary(INJURIES)), by = EVTYPE]
datStatsInj <- datStatsInj[order(Mean, decreasing = TRUE)]
```

#### Economic Damage
```{r sumStatsDmg}
datStatsDmg <- datSumYearType[, as.list(summary(DMGTOT)), by = EVTYPE]
datStatsDmg <- datStatsDmg[order(Mean, decreasing = TRUE)]
```

### Annual Impact

#### Health
```{r healthImpact}
datPlot <- datSumYearType[EVTYPE %in% datStatsFtl[1:5]$EVTYPE]
datPlot <- melt(datPlot, id = c("YEAR", "EVTYPE"), measure = c("FATALITIES", "INJURIES"))

qplot(factor(EVTYPE), log10(value), data = datPlot, geom = "boxplot", facets = . ~ variable)
rm(datPlot)
```

#### Economic
```{r econImpact}
datPlot <- datSumYearType[EVTYPE %in% datStatsDmg[1:5]$EVTYPE]
datPlot <- melt(datPlot, id = c("YEAR", "EVTYPE"), measure = "DMGTOT")

qplot(factor(EVTYPE), log10(value), data = datPlot, geom = "boxplot", facets = . ~ variable)
rm(datPlot)
```

### Single Event Economic Impact
```{r singleEvent}
datMaxType <- dat[, list(max(DMGTOT), (max(DMGTOT) - mean(DMGTOT)) / sd(DMGTOT)), "EVTYPECLEAN"]
setnames(datMaxType, c("EVTYPE", "DMGTOT", "SD"))
datMaxType <- datMaxType[order(DMGTOT, decreasing = TRUE)]

qplot(DMGTOT, SD, data = datMaxType[1:10], color = EVTYPE)
```

## Conclusion