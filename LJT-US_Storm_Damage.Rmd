---
title: "Damage Analysis of U.S. Storm Activity"
author: "Logan J Travis"
date: "21 June 2014"
output: html_document
---

## Synopziz

## Data Processing

Data provided by NOAA for storm actity from 1950 through November 2011. Please see the 

### Access Data

```{r accessDat}
# Store link to NOAA Storm Data
link <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"

# Download data and save to ./data if not present
# Checks for timestamp downloading a new copy of the data if not present
if(!file.exists("./data")) dir.create("./data")
if(sum(file.exists(c("./data/StormData.csv.bz2", "./data/Timestamp.txt"))) < 2 ) {
    download.file(link, destfile = "./data/StormData.csv.bz2", method = "curl")
    write.table(date(), file = "./data/Timestamp.txt", col.names = F, row.names = F)
    print("Storm Data downloaded succesfully")
} else {
    timestamp <- format(read.table("./data/Timestamp.txt"))
    print(paste("Using Storm Data with timestamp", timestamp))
}
```

### Read Data
```{r readDat}
# Load data.table package
library(data.table)

# List column classes including NULL to skip data not used in analysis
cols <- c("numeric",  # STATE
          "character",  # BGN_DATE (will convert to Date)
          "NULL",  # BGN_TIME
          "NULL",  # BGN_TIME
          "NULL",  # COUNTY
          "NULL",  # COUNTYNAME
          "factor",  # STATE
          "character",  # EVTYPE (character class to simplify cleanup)
          "NULL",  # BGN_RANGE
          "NULL",  # BGN_AZI
          "NULL",  # BGN_LOCATION
          "NULL",  # END_DATE (too many blanks for useful analysis)
          "NULL",  # END_TIME
          "NULL",  # COUNTY_END
          "NULL",  # COUNTYENDN
          "NULL",  # END_RANGE
          "NULL",  # END_AZI
          "NULL",  # END_LOCATION
          "NULL",  # LENGTH
          "NULL",  # WIDTH
          "NULL",  # F
          "NULL",  # MAG
          "numeric",  # FATALITIES
          "numeric",  # INJURIES
          "numeric",  # PROPDMG
          "factor",  # PROPDMGEXP
          "numeric",  # CROPDMG
          "factor",  # CROPDMGEXP
          "NULL",  # WFO
          "NULL",  # STATEOFFICE
          "NULL",  # ZONENAMES
          "NULL",  # LATTITUDE
          "NULL",  # LONGITUDE
          "NULL",  # LATITUDE_E
          "NULL",  # LONGITUDE_
          "NULL",  # REMARKS
          "numeric"  # REFNUM
         )

# Read Storm Data then convert to data.table to speed cleanup
# Calls read.csv() because fread produced an unknown error
dat <- data.table(read.csv("./data/StormData.csv.bz2", colClasses = cols))

# Print data summary
print(str(dat))

# Clear variables
rm(cols)
```

### Clean Data
1. Change STATE__ columne name to STATENUM
```{r cleanDatSTATENUM}
    setnames(dat, "STATE__", "STATENUM")
```
2. Convert begin date from character to Date format then add separate year column
    ```{r cleanDatDate}
    dat$BGN_DATE <- dat[, as.Date(BGN_DATE, format = "%m/%d/%Y %T")]
    dat[, YEAR := year(BGN_DATE)]
    ```
3. Clean event types (multiple steps)
    ```{r cleanDatEVTYPE, cache = TRUE}
    # Load plyr package
    library(plyr)

    # Count event types before clenup
    print(length(unique(dat$EVTYPE)))

    # Create data.frame of unique EVTYPE values
    # Copies columns to enable replacement matching
    evtypes <- summarize(dat, EVTYPE = count(EVTYPE))[[1]]
    names(evtypes) <- c("EVTYPE", "COUNT")
    evtypes$CLEAN <- evtypes$EVTYPE
    
    # EXPLAIN
    evtypesPermit <- read.csv("./data/evtypes.csv", stringsAsFactors = FALSE)[[1]]
    
    # Convert to upper case
    evtypes$CLEAN <- toupper(evtypes$CLEAN)
    evtypesPermit <- toupper(evtypesPermit)

    # Replace non-alphanumeric with . and remove duplicates
    evtypes$CLEAN <- gsub("[^0-9A-Z]", ".", evtypes$CLEAN)
    evtypes$CLEAN <- gsub("\\.{2, }", ".", evtypes$CLEAN)
    #
    evtypesPermit <- gsub("[^0-9A-Z]", ".", evtypesPermit)
    evtypesPermit <- gsub("\\.{2, }", ".", evtypesPermit)

    # Remove leading and ending .
    evtypes$CLEAN <- gsub("^\\.+", "", evtypes$CLEAN)
    evtypes$CLEAN <- gsub("\\.+$", "", evtypes$CLEAN)
    #
    evtypesPermit <- gsub("^\\.+", "", evtypesPermit)
    evtypesPermit <- gsub("\\.+$", "", evtypesPermit)

    # Replace 'THUNDERSTORM' with 'TSTM'
    evtypes$CLEAN <- gsub("THUNDERSTORM", "TSTM", evtypes$CLEAN)
    evtypesPermit <- gsub("THUNDERSTORM", "TSTM", evtypesPermit)
    
    # Simplify 'FLASH FLOOD'
    evtypes$CLEAN <- gsub("FLASH FLOOD.*FLOOD", "FLASH FLOOD", evtypes$CLEAN)
    
    # Simplify 'HEAVY RAIN' (includes 'HEAVY PRECIPITATION' and 'HEAVY SHOWERS')
    evtypes$CLEAN <- gsub("HEAVY (PRECIPITATION|SHOWERS)", "HEAVY RAIN", evtypes$CLEAN)
    
    # Simplify 'HIGH WIND(S)' and 'STRONG WIND(S)'
    evtypes$CLEAN <- gsub("(HIGH|STRONG) WIND", "HIGH WIND", evtypes$CLEAN)

    # Simplify split 'HURRICANE.TYPHOON' in permitted event types
    evtypesPermit[grepl("^HURRICANE", evtypesPermit)] <- "HURRICANE"
    evtypesPermit <- c(evtypesPermit, "TYPHOON")    

    # Order permitted event types by fewest number of characters
    evtypesPermit <- evtypesPermit[order(nchar(evtypesPermit))]
    
    # Search and replace by permitted event types
    for(ev in evtypesPermit) {
        evtypes$CLEAN[grepl(ev, evtypes$CLEAN)] <- ev
    }
    rm(ev)

    # Merge clean event types into data
    evtypesMerge <- data.table(EVTYPE = evtypes$EVTYPE, EVTYPECLEAN = evtypes$CLEAN)
    dat <- merge(dat, evtypesMerge, by = "EVTYPE", all.x = TRUE)
    
    # Count event types after clenup
    print(length(unique(dat$EVTYPECLEAN)))
    ```
4. Multiply property and crop damage by 'EXP' to calculate total
    ```{r cleanDatDamage}
    # Create function to lookup 'EXP' multiple
    expMultiple <- function(exp) {
        switch(tolower(exp), k = 1E+3, m = 1E+6, b = 1E+9, 1)
    }
    
    # Add total property and crop damage columns
    dat[, PROPDMGTOT := {exp <- sapply(dat$PROPDMGEXP, expMultiple); PROPDMG * exp}]
    dat[, CROPDMGTOT := {exp <- sapply(dat$CROPDMGEXP, expMultiple); CROPDMG * exp}]

    # Add total damage column
    dat[, DMGTOT := PROPDMGTOT + CROPDMGTOT]
    ```
5. Clear temporary variables
    ```{r cleanDatClear}
    rm(evtypes, evtypesPermit, evtypesMerge, expMultiple)
    ```
## Results

### Summary Statistics
Summarize by year
```{r sumStats}
# Summarize data by year and type
datSumYearType <- dat[, list(sum(FATALITIES), sum(INJURIES), sum(DMGTOT)),
                      by = c("YEAR", "EVTYPECLEAN")]
setnames(datSumYearType, c("YEAR", "EVTYPE", "FATALITIES", "INJURIES", "DMGTOT"))
```

#### Annual Fatalities
```{r sumStatsFtl}
datStatsFtl <- datSumYearType[, as.list(summary(FATALITIES)), by = EVTYPE]
datStatsFtl <- datStatsFtl[order(Mean, decreasing = TRUE)]
```

#### Injuries
```{r sumStatsInj}
datStatsInj <- datSumYearType[, as.list(summary(INJURIES)), by = EVTYPE]
datStatsInj <- datStatsInj[order(Mean, decreasing = TRUE)]
```

#### Economic Damage
```{r sumStatsDmg}
datStatsDmg <- datSumYearType[, as.list(summary(DMGTOT)), by = EVTYPE]
datStatsDmg <- datStatsDmg[order(Mean, decreasing = TRUE)]
```

### Annual Impact

#### Health
```{r healthImpact}
# Load ggplot2 and reshape packages
library(ggplot2)
library(reshape)

datPlot <- datSumYearType[EVTYPE %in% datStatsFtl[1:5]$EVTYPE]
datPlot <- melt(datPlot, id = c("YEAR", "EVTYPE"), measure = c("FATALITIES", "INJURIES"))

qplot(factor(EVTYPE), log10(value), data = datPlot, geom = "boxplot", facets = . ~ variable)
rm(datPlot)
```

#### Economic
```{r econImpact}
datPlot <- datSumYearType[EVTYPE %in% datStatsDmg[1:5]$EVTYPE]
datPlot <- melt(datPlot, id = c("YEAR", "EVTYPE"), measure = "DMGTOT")

qplot(factor(EVTYPE), log10(value), data = datPlot, geom = "boxplot", facets = . ~ variable)
rm(datPlot)
```

### Single Event Economic Impact
```{r singleEvent}
datMaxType <- dat[, list(max(DMGTOT), (max(DMGTOT) - mean(DMGTOT)) / sd(DMGTOT)), "EVTYPECLEAN"]
setnames(datMaxType, c("EVTYPE", "DMGTOT", "SD"))
datMaxType <- datMaxType[order(DMGTOT, decreasing = TRUE)]

qplot(DMGTOT, SD, data = datMaxType[1:10], color = EVTYPE)
```

## Conclusion